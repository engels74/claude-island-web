name: Update Appcast

on:
  repository_dispatch:
    types: [update-appcast]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout website
        uses: actions/checkout@v6

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Update appcast.xml
        env:
          VERSION: ${{ github.event.client_payload.version }}
          DOWNLOAD_URL: ${{ github.event.client_payload.download_url }}
          ED_SIGNATURE: ${{ github.event.client_payload.ed_signature }}
          FILE_SIZE: ${{ github.event.client_payload.file_size }}
          MIN_SYSTEM_VERSION: ${{ github.event.client_payload.min_system_version }}
        run: |
          python3 scripts/update-appcast.py

      - name: Update src/config.ts
        env:
          VERSION: ${{ github.event.client_payload.version }}
          DOWNLOAD_URL: ${{ github.event.client_payload.download_url }}
        run: |
          printf '%s\n' \
            "// Auto-updated by GitHub Actions when new releases are published" \
            "export const LATEST_VERSION = \"${VERSION}\";" \
            "export const DOWNLOAD_URL = \"${DOWNLOAD_URL}\";" \
            > src/config.ts

      - name: Format config.ts with Biome
        run: bunx biome format --write src/config.ts

      - name: Commit and push changes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/appcast.xml src/config.ts
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Update appcast for v${{ github.event.client_payload.version }}"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Build project
        if: steps.commit.outputs.changed == 'true'
        run: bun run build

      - name: Deploy to GitHub Pages
        if: steps.commit.outputs.changed == 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          cname: claudeisland.engels74.net

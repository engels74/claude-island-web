name: Update Appcast

on:
  repository_dispatch:
    types: [update-appcast]

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout website
        uses: actions/checkout@v6

      - name: Update appcast.xml
        env:
          VERSION: ${{ github.event.client_payload.version }}
          DOWNLOAD_URL: ${{ github.event.client_payload.download_url }}
          ED_SIGNATURE: ${{ github.event.client_payload.ed_signature }}
          FILE_SIZE: ${{ github.event.client_payload.file_size }}
          MIN_SYSTEM_VERSION: ${{ github.event.client_payload.min_system_version }}
        run: |
          python3 scripts/update-appcast.py

      - name: Update src/config.ts
        env:
          VERSION: ${{ github.event.client_payload.version }}
          DOWNLOAD_URL: ${{ github.event.client_payload.download_url }}
        run: |
          cat > src/config.ts << EOF
          // Auto-updated by GitHub Actions when new releases are published
          export const LATEST_VERSION = "${VERSION}";
          export const DOWNLOAD_URL = "${DOWNLOAD_URL}";
          EOF

      - name: Commit and push changes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/appcast.xml src/config.ts
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Update appcast for v${{ github.event.client_payload.version }}"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger deployment
        if: steps.commit.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run deploy.yml
